extends ../layouts/layout

block flash

block content
  section.section-gray.mini-section
    .container.clearfix
      .row
        .col-md-12
          h3.heading #{__('Bonjour')}
            span.accent &nbsp;#{user.username}
            | ,
            p #{__('Vous êtes inscrit depuis le')} #{user.createdAt}


          include ../Elements/flash

          ul.nav.nav-tabs(role="tablist")
            li.nav-item
              a.nav-link.active(data-toggle="tab" href="#infos" role="tab") #{__('Vos informations')} #{__('personnelles')}
            li.nav-item
              a.nav-link(data-toggle="tab" href="#licenses" role="tab") #{__('Vos licences')}
            li.nav-item
              a.nav-link(data-toggle="tab" href="#hostings" role="tab") #{__('Vos hébergements')}
            li.nav-item
              a.nav-link(data-toggle="tab" href="#transactions" role="tab") #{__('Vos transactions')}
            li.nav-item
              a.nav-link(data-toggle="tab" href="#connections" role="tab") #{__('Vos connexions')}


          div.tab-content
            div.tab-pane.fade.in.active(id="infos" role="tabpanel")

              // ===================================
                 ==== Informations personnelles ====
                 ===================================

              h4 #{__('Vos informations')}
                span.accent &nbsp;#{__('personnelles')}

              .row
                .col-md-6

                   form(method="post", action="/user/edit-email", data-ajax, data-custom-callback='emailUpdated')
                     .form-group
                       label #{__("Adresse email actuelle")}
                       input.form-control.disabled#current_email(type='email', disabled, value=user.email)
                     .form-group
                       label #{__("Vous souhaitez changer d'email ?")}
                       input.form-control(type='email', name="email", placeholder=__("Entrez ici votre nouvelle adresse email"))

                     .form-group.text-center
                       button.btn.btn-outline-success(type='submit') #{__("Changer mon adresse email")}

                   hr.hidden-md-up

                .col-md-6.left-vertical-separator

                   form(method="post", action="/user/edit-password", data-ajax)
                     .form-group
                       label #{__('Mot de passe')}
                       input.form-control(type='password', name="password")
                       small.form-text.text-muted #{__("Choississez un mot de passe fort et unique pour que personne ne puisse accéder à votre compte.")}
                     .form-group
                       label #{__('Confirmation du mot de passe')}
                       input.form-control(type='password', name="password_confirmation")
                       small.form-text.text-muted #{__("Répéter votre mot de passe")}

                     .form-group.text-center
                       button.btn.btn-outline-success(type='submit') #{__("Changer mon mot de passe")}

            div.tab-pane.fade(id="licenses" role="tabpanel")

              // ===================================
                 ======== Liste des licenses =======
                 ===================================

              div.alert.alert-info
                b #{__('Hébergeur compatible :')}
                | &nbsp;!{__("L'hébergeur <a href=\"http://revolta-hosting.fr\" target=\"_blank\">Revolta-Hosting</a> est 100% <b>compatible</b> avec notre CMS ! Vous pouvez d'ailleurs utilisez le code de promotion <i>MINEWEB</i> pour obtenir 20% de réduction sur l'offre <b>Start</b> de leur hébergement mutualisé.")}

              if user.licenses !== undefined && user.licenses.length > 0
                div.table-responsive
                  table.table
                    thead
                      tr
                        th #{__('Site')}
                        th #{__("Clé d'activation")}
                        th #{__('Statut')}
                        th #{__("Date d'achat")}
                        th #{__('Actions')}
                    tbody
                      each license, index in user.licenses
                        tr(class=license.suspended !== null ? 'disabled' : '', style=license.suspended !== null ? 'opacity:0.5;' : '')
                          td
                            a(href=license.host, target='_blank')
                              | #{license.host}
                          td #{license.key}
                          td
                            if license.state
                              span.tag.tag-success #{__('Activée')}
                            else
                              span.tag.tag-danger #{__('Désactivée')}
                          td.moment-date(data-format=__('Le {L} à {LT}')) #{license.createdAt}
                          td
                            div.btn-group-vertical
                              if license.state
                                button.btn.btn-danger.disable-license(data-license-id=license.id) #{__('Désactiver')}
                              else if !license.state && license.suspended === null
                                button.btn.btn-success.enable-license(data-license-id=license.id) #{__('Activer')}
                              else
                                button.btn.btn-success.disabled(disabled) #{__('Activer')}
                              button.btn.btn-info.edit-host-license(data-license-id=license.id) #{__("Modifier l'URL")}
                              a.btn.btn-success(href='/license/download/'+license.id) #{__('Télécharger')}
                          if license.suspended !== null
                            tr(style="position: absolute;margin-top: -112px;")
                              td(style='border-top: none;')
                                h3.text-danger(style="opacity:1;")
                                  | #{__('Licence désactivée pour :')} #{license.suspended}
              else
                div.alert.alert-danger !{__('Vous ne disposez pas encore de license ! Vous pouvez dès maintenant en achetez une sur <a href="/download">cette page</a>.')}

            div.tab-pane.fade(id="hostings" role="tabpanel")

              // ===================================
                 ====== Liste des hébergements =====
                 ===================================


              if user.hostings !== undefined && user.hostings.length > 0
                div.table-responsive
                  table.table
                    thead
                      tr
                        th #{__('Site')}
                        th #{__("Clé d'activation")}
                        th #{__('Statut')}
                        th #{__("Date d'expiration")}
                        th #{__("Date d'achat")}
                        th #{__('Actions')}
                    tbody
                      each hosting, index in user.hostings
                        tr(class=hosting.suspended !== null ? 'disabled' : '', style=hosting.suspended !== null ? 'opacity:0.5;' : '')
                          td
                            if hosting.host_type === 'SUBDOMAIN'
                               a(href='http://'+hosting.host+'.craftwb.fr', target='_blank')
                                 | http://#{hosting.host}.craftwb.fr
                            else
                              a(href='http://'+hosting.host, target='_blank')
                                | http://#{hosting.host}
                          td #{hosting.key}
                          td
                            if hosting.state
                              span.tag.tag-success #{__('Activé')}
                            else
                              span.tag.tag-danger #{__('Désactivé')}
                          td
                            // Si la date de fin est inférieur à dans 1 semaine, l'hébergement va bientôt expiré
                            if (new Date(hosting.endDate)).getTime() < (new Date(Date.now() - (7 * 24 * 60 * 60 * 1000)))
                              span.text-danger.moment-date(data-format=__('Le {L} à {LT}')) #{hosting.endDate}
                            else
                              span.moment-date(data-format=__('Le {L} à {LT}')) #{hosting.endDate}
                          td.moment-date(data-format=__('Le {L} à {LT}')) #{hosting.createdAt}
                          td
                            div.btn-group-vertical
                              button.edit-host-hosting.btn.btn-info(data-hosting-id=hosting.id) #{__("Modifier le nom de domaine")}
                              a(href='/hosting/renew/'+hosting.id).btn.btn-success #{__('Renouveler')}
                        if hosting.suspended !== null
                          tr(style="position: absolute;margin-top: -112px;")
                            td(style='border-top: none;')
                              h3.text-danger(style="opacity:1;")
                                | #{__('Hébergement désactivé pour :')} #{hosting.suspended}
              else
                div.alert.alert-danger !{__('Vous ne disposez pas encore d\'hébergement ! Vous pouvez dès maintenant en louer un sur <a href="/download">cette page</a>.')}

            div.tab-pane.fade(id="transactions" role="tabpanel")

              // ===================================
                 ====== Liste des transactions =====
                 ===================================

              h4 #{__('Vos transactions')}
                span.accent &nbsp;#{__('PayPal')}

              if user.paypalPayments !== undefined && user.paypalPayments.length > 0
                div.table-responsive
                  table.table
                    thead
                      tr
                        th #{__('ID de la transaction')}
                        th #{__('Montant de la transaction')}
                        th #{__('Email PayPal')}
                        th #{__('Date du paiement')}
                        th #{__('Statut')}
                    tbody
                      each payment, index in user.paypalPayments
                        tr
                          td
                            a(href='https://www.paypal.com/fr/cgi-bin/webscr?cmd=_view-a-trans&id='+payment.paymentId, target='_blank') #{payment.paymentId}
                          td #{payment.paymentAmount} €
                          td #{payment.buyerEmail}
                          td.moment-date(data-format=__('Le {L} à {LT}')) #{payment.paymentDate}
                          td
                            if payment.state === 'COMPLETED'
                              span.tag.tag-success #{__('Complété')}
                            else if payment.state === 'SUSPENDED'
                              span.tag.tag-warning #{__('Suspendu')}
                            else
                              span.tag.tag-danger #{__('Remboursé')}
              else
                div.alert.alert-warning !{__("Vous n'avez pas encore effectué de transaction PayPal sur votre compte.")}

              hr

              h4 #{__('Vos transactions')}
                span.accent &nbsp;#{__('Dédipass')}

              if user.dedipassPayments !== undefined && user.dedipassPayments.length > 0
                div.table-responsive
                  table.table
                    thead
                      tr
                        th #{__('Montant de la transaction')}
                        th #{__('Code utilisé')}
                        th #{__('Palier utilisé')}
                        th #{__('Date du paiement')}
                    tbody
                      each payment, index in user.dedipassPayments
                        tr
                          td #{payment.amount} €
                          td #{payment.code}
                          td #{payment.rate}
                          td.moment-date(data-format=__('Le {L} à {LT}')) #{payment.createdAt}
              else
                div.alert.alert-warning !{__("Vous n'avez pas encore effectué de transaction Dédipass sur votre compte.")}

            div.tab-pane.fade(id="connections" role="tabpanel")

              // ==========================================
                 ===== Liste des dernières connexions =====
                 ==========================================

              h4 #{__('Vos dernières')}
                span.accent &nbsp;#{__('connexions')}

              if user.connectionLogs !== undefined && user.connectionLogs.length > 0
                div.table-responsive
                  table.table
                    thead
                      tr
                        th #{__('Date de la connexion')}
                        th #{__('Adresse IP de connexion')}
                    tbody
                      each connection, index in user.connectionLogs
                        tr
                          td.moment-date(data-format='Le {L} à {LT}') #{connection.createdAt}
                          td #{connection.ip}


              hr
              // =================================================
                 ===== Gestion de la double authentification =====
                 =================================================

              h4 #{__('Gestion de la')}
                span.accent &nbsp;#{__('double authentification')}

              p.lead
                small
                  em #{__("La double authentification est une fonctionnalité permettant de renforcer l'accès à votre compte utilisateur. Elle utilise pour cela un code à usage unique en plus du traditionnel mot de passe.")}

              if user.twoFactorAuthKey === undefined || user.twoFactorAuthKey === null
                div.text-center
                  a(href='/user/two-factor-auth/enable').btn.btn-outline-success #{__('Activer la double authentification sur mon compte')}
              else
                div.text-center
                  a(href='/user/two-factor-auth/disable').btn.btn-outline-danger #{__('Désactiver la double authentification sur mon compte')}


block custom
  script(type='text/javascript').
    function emailUpdated(data, response) {
      $('#current_email').val($('input[name="email"]').val())
    }
